services:
  # Orchestrator service
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    container_name: grpc_orchestrator
    hostname: orchestrator
    networks:
      - grpc_network
    ports:
      - "50050:50050"
    command: >
      ./orchestrator_main
      --address 0.0.0.0:50050
      --schedule schedules/example_parametrized.yaml
      --policy fifo
      --priority 80
      --cpu-affinity 0
      --lock-memory
    environment:
      - LISTEN_ADDRESS=0.0.0.0:50050
      - DOCKER_CONTAINER=true
      - TZ=UTC
    # Time synchronization with host
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    # Real-time configuration
    cpuset: "0"
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    depends_on:
      - task1
      - task2
      - task3
    healthcheck:
      test: ["CMD", "pgrep", "-f", "orchestrator_main"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Task 1
  task1:
    build:
      context: .
      dockerfile: Dockerfile.task
    container_name: grpc_task1
    hostname: task1
    networks:
      - grpc_network
    ports:
      - "50051:50051"
    command: >
      ./task1_data_analyzer
      --name task_1
      --address 0.0.0.0:50051
      --orchestrator orchestrator:50050
    environment:
      - TASK_ID=task_1
      - LISTEN_ADDRESS=0.0.0.0:50051
      - ORCHESTRATOR_ADDRESS=orchestrator:50050
      - TZ=UTC
    # Time synchronization with host
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    # Real-time configuration (allow any CPU)
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "pgrep", "-f", "task1_data_analyzer"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Task 2
  task2:
    build:
      context: .
      dockerfile: Dockerfile.task
    container_name: grpc_task2
    hostname: task2
    networks:
      - grpc_network
    ports:
      - "50052:50052"
    command: >
      ./task2_image_processor
      --name task_2
      --address 0.0.0.0:50052
      --orchestrator orchestrator:50050
    environment:
      - TASK_ID=task_2
      - LISTEN_ADDRESS=0.0.0.0:50052
      - ORCHESTRATOR_ADDRESS=orchestrator:50050
      - TZ=UTC
    # Time synchronization with host
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    # Real-time configuration (allow any CPU)
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "pgrep", "-f", "task2_image_processor"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Task 3
  task3:
    build:
      context: .
      dockerfile: Dockerfile.task
    container_name: grpc_task3
    hostname: task3
    networks:
      - grpc_network
    ports:
      - "50053:50053"
    command: >
      ./task3_report_generator
      --name task_3
      --address 0.0.0.0:50053
      --orchestrator orchestrator:50050
    environment:
      - TASK_ID=task_3
      - LISTEN_ADDRESS=0.0.0.0:50053
      - ORCHESTRATOR_ADDRESS=orchestrator:50050
      - TZ=UTC
    # Time synchronization with host
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    # Real-time configuration (allow any CPU)
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "pgrep", "-f", "task3_report_generator"]
      interval: 5s
      timeout: 3s
      retries: 3

networks:
  grpc_network:
    driver: bridge
