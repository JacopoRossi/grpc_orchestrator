version: '3.8'

services:
  # Orchestrator service
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    container_name: grpc_orchestrator
    hostname: orchestrator
    networks:
      - grpc_network
    ports:
      - "50050:50050"
    command: >
      ./orchestrator_main
      --address 0.0.0.0:50050
      --policy fifo
      --priority 80
      --cpu-affinity 0
    environment:
      - LISTEN_ADDRESS=0.0.0.0:50050
      - DOCKER_CONTAINER=true
    # Real-time configuration
    cpuset: "0"
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    depends_on:
      - task1
      - task2
      - task3
    healthcheck:
      test: ["CMD", "pgrep", "-f", "orchestrator_main"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Task 1
  task1:
    build:
      context: .
      dockerfile: Dockerfile.task
    container_name: grpc_task1
    hostname: task1
    networks:
      - grpc_network
    ports:
      - "50051:50051"
    command: >
      ./task_main
      --name task_1
      --address 0.0.0.0:50051
      --orchestrator orchestrator:50050
      --policy fifo
      --priority 75
      --cpu-affinity 1
    environment:
      - TASK_ID=task_1
      - LISTEN_ADDRESS=0.0.0.0:50051
      - ORCHESTRATOR_ADDRESS=orchestrator:50050
    # Real-time configuration
    cpuset: "1"
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "pgrep", "-f", "task_main"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Task 2
  task2:
    build:
      context: .
      dockerfile: Dockerfile.task
    container_name: grpc_task2
    hostname: task2
    networks:
      - grpc_network
    ports:
      - "50052:50051"
    command: >
      ./task_main
      --name task_2
      --address 0.0.0.0:50051
      --orchestrator orchestrator:50050
      --policy fifo
      --priority 75
      --cpu-affinity 2
    environment:
      - TASK_ID=task_2
      - LISTEN_ADDRESS=0.0.0.0:50051
      - ORCHESTRATOR_ADDRESS=orchestrator:50050
    # Real-time configuration
    cpuset: "2"
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "pgrep", "-f", "task_main"]
      interval: 5s
      timeout: 3s
      retries: 3

  # Task 3
  task3:
    build:
      context: .
      dockerfile: Dockerfile.task
    container_name: grpc_task3
    hostname: task3
    networks:
      - grpc_network
    ports:
      - "50053:50051"
    command: >
      ./task_main
      --name task_3
      --address 0.0.0.0:50051
      --orchestrator orchestrator:50050
      --policy fifo
      --priority 75
      --cpu-affinity 3
    environment:
      - TASK_ID=task_3
      - LISTEN_ADDRESS=0.0.0.0:50051
      - ORCHESTRATOR_ADDRESS=orchestrator:50050
    # Real-time configuration
    cpuset: "3"
    cap_add:
      - SYS_NICE
    ulimits:
      rtprio: 99
      rttime: -1
      memlock: 2048000000
    security_opt:
      - seccomp:unconfined
    healthcheck:
      test: ["CMD", "pgrep", "-f", "task_main"]
      interval: 5s
      timeout: 3s
      retries: 3

networks:
  grpc_network:
    driver: bridge
    name: grpc_orchestrator_network
